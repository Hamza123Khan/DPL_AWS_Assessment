name: Deploy Bedrock API with AWS CDK

on:
  push:
    branch: 
      - main

jobs:
  deploy:
    runs-on: ubuntu:latest
    premissions:
      id-token: read
      contents: write
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
    - name: Insatall Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install aws-cdk-lib.aws-lambda-python-alpha flake8 pytest bandit
    - name: Run Test (pytest)
      run: |
        pytest -q
    - name: Security Scan (bandit)
      run: bandit -r . -ll
    - name: Insatall CDK
      run: npm install -g -aws-cdk
    - name: CDK Bootstrap (only needed once)
      working-directory: infra
      run: |
        cdk bootstrap aws://$(aws sts get-caller-identity --query Account --output text)/${{ vars.AWS_REGION }}
    - name: CDK Deploy
      run: cdk deploy --require-approval never
    - name: notification on slack for the deployment (Deploy Success)
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"CDK deployment succeeded for Bedrock API on main branch."}' \
        ${{ secrets.SLACK_WEBHOOK_URL }}
    - name: notification on slack for the deployment (Deploy failed)
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"CDK deployment failed for Bedrock API on main branch."}' \
        ${{ secrets.SLACK_WEBHOOK_URL }}
